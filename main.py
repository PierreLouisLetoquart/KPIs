from utils.period_filters import load_csv, check_csv_has_created_at_column, get_period_filter, filter_csv_with_period
from kpis.metrics import fetch_supabase_logs
from utils.supabase import create_supabase_client, store_data_to_csv
from kpis.orders import count_fringuant_orders

import json

def test_period_filter() -> None:
    # Test load_csv function
    data = load_csv("./data/orders.csv")
    print(f"Number of rows in original data: {len(data)}")

    # Test check_csv_has_created_at_column function
    has_created_at = check_csv_has_created_at_column(data)
    print(has_created_at)

    # Test get_period_filter function
    period_type = "trimester"
    date_range = get_period_filter(period_type)
    print(date_range)

    # Test filter_csv_with_period function
    filtered_data = filter_csv_with_period(data, date_range)
    print(f"Number of rows in filtered data: {len(filtered_data)}")

def test_fetch_supabase_logs() -> None:
    # Test fetch_supabase_logs function
    supabase = create_supabase_client()
    df_logs = fetch_supabase_logs(supabase)
    store_data_to_csv(df_logs, "./data/tests/logs.csv")

jsondata = {'order_created': {'id': 5549461897557, 'name': '#8469', 'note': None, 'tags': '', 'test': False, 'email': 'enora.poignard@gmail.com', 'phone': None, 'token': '7912169a23e028951f18bcec38c2fc52', 'app_id': 580111, 'number': 7469, 'gateway': 'PayPlug', 'refunds': [], 'user_id': None, 'currency': 'EUR', 'customer': {'id': 7046893044053, 'note': None, 'tags': '', 'email': 'enora.poignard@gmail.com', 'phone': None, 'state': 'enabled', 'currency': 'EUR', 'last_name': 'Poignard', 'created_at': '2023-04-17T11:28:19+02:00', 'first_name': 'Enora', 'tax_exempt': False, 'updated_at': '2023-04-17T11:32:12+02:00', 'tax_exemptions': [], 'verified_email': False, 'default_address': {'id': 9540221403477, 'zip': '29200', 'city': 'Brest', 'name': 'Enora Poignard', 'phone': '06 89 58 38 87', 'company': None, 'country': 'France', 'default': True, 'address1': '7b Place des F.T.P.F', 'address2': None, 'province': None, 'last_name': 'Poignard', 'first_name': 'Enora', 'customer_id': 7046893044053, 'country_code': 'FR', 'country_name': 'France', 'province_code': None}, 'accepts_marketing': False, 'admin_graphql_api_id': 'gid://shopify/Customer/7046893044053', 'multipass_identifier': None, 'sms_marketing_consent': None, 'marketing_opt_in_level': None, 'email_marketing_consent': {'state': 'not_subscribed', 'opt_in_level': 'single_opt_in', 'consent_updated_at': None}, 'accepts_marketing_updated_at': '2023-04-17T11:28:19+02:00'}, 'closed_at': None, 'confirmed': True, 'device_id': None, 'reference': 'fce49de355d7f8ba51b5c7c073d605bd', 'tax_lines': [{'rate': 0.2, 'price': '129.17', 'title': 'FR TVA', 'price_set': {'shop_money': {'amount': '129.17', 'currency_code': 'EUR'}, 'presentment_money': {'amount': '129.17', 'currency_code': 'EUR'}}, 'channel_liable': False}], 'total_tax': '129.17', 'browser_ip': '80.215.36.11', 'cart_token': '877a5d72fb9fe1a9b0fd9be03ba7af63', 'created_at': '2023-04-17T11:32:11+02:00', 'line_items': [{'id': 14532646666581, 'sku': 'pantalon-newyork-noir-34', 'name': 'Pantalon tailleur New-York - Noir - 34', 'grams': 0, 'price': '195.00', 'title': 'Pantalon tailleur New-York - Noir', 'duties': [], 'vendor': '17h10', 'taxable': True, 'quantity': 1, 'gift_card': False, 'price_set': {'shop_money': {'amount': '195.00', 'currency_code': 'EUR'}, 'presentment_money': {'amount': '195.00', 'currency_code': 'EUR'}}, 'tax_lines': [{'rate': 0.2, 'price': '32.50', 'title': 'FR TVA', 'price_set': {'shop_money': {'amount': '32.50', 'currency_code': 'EUR'}, 'presentment_money': {'amount': '32.50', 'currency_code': 'EUR'}}, 'channel_liable': False}], 'product_id': 3982788329544, 'properties': [], 'variant_id': 29665295302728, 'variant_title': '34', 'product_exists': True, 'total_discount': '0.00', 'requires_shipping': True, 'fulfillment_status': None, 'total_discount_set': {'shop_money': {'amount': '0.00', 'currency_code': 'EUR'}, 'presentment_money': {'amount': '0.00', 'currency_code': 'EUR'}}, 'fulfillment_service': 'manual', 'admin_graphql_api_id': 'gid://shopify/LineItem/14532646666581', 'discount_allocations': [], 'fulfillable_quantity': 1, 'variant_inventory_management': 'shopify'}, {'id': 14532646699349, 'sku': 'jupe-milan-noir-34', 'name': 'Jupe tailleur Milan - Noire - 34', 'grams': 0, 'price': '195.00', 'title': 'Jupe tailleur Milan - Noire', 'duties': [], 'vendor': '17h10', 'taxable': True, 'quantity': 1, 'gift_card': False, 'price_set': {'shop_money': {'amount': '195.00', 'currency_code': 'EUR'}, 'presentment_money': {'amount': '195.00', 'currency_code': 'EUR'}}, 'tax_lines': [{'rate': 0.2, 'price': '32.50', 'title': 'FR TVA', 'price_set': {'shop_money': {'amount': '32.50', 'currency_code': 'EUR'}, 'presentment_money': {'amount': '32.50', 'currency_code': 'EUR'}}, 'channel_liable': False}], 'product_id': 3987661193288, 'properties': [], 'variant_id': 29692445950024, 'variant_title': '34', 'product_exists': True, 'total_discount': '0.00', 'requires_shipping': True, 'fulfillment_status': None, 'total_discount_set': {'shop_money': {'amount': '0.00', 'currency_code': 'EUR'}, 'presentment_money': {'amount': '0.00', 'currency_code': 'EUR'}}, 'fulfillment_service': 'manual', 'admin_graphql_api_id': 'gid://shopify/LineItem/14532646699349', 'discount_allocations': [], 'fulfillable_quantity': 1, 'variant_inventory_management': 'shopify'}, {'id': 14532646732117, 'sku': 'veste-paris-noir-34', 'name': 'Veste tailleur Paris - Noire - 34', 'grams': 0, 'price': '385.00', 'title': 'Veste tailleur Paris - Noire', 'duties': [], 'vendor': '17h10', 'taxable': True, 'quantity': 1, 'gift_card': False, 'price_set': {'shop_money': {'amount': '385.00', 'currency_code': 'EUR'}, 'presentment_money': {'amount': '385.00', 'currency_code': 'EUR'}}, 'tax_lines': [{'rate': 0.2, 'price': '64.17', 'title': 'FR TVA', 'price_set': {'shop_money': {'amount': '64.17', 'currency_code': 'EUR'}, 'presentment_money': {'amount': '64.17', 'currency_code': 'EUR'}}, 'channel_liable': False}], 'product_id': 3985605820488, 'properties': [{'name': '_added_via_fringuant', 'value': 'true'}], 'variant_id': 29682365857864, 'variant_title': '34', 'product_exists': True, 'total_discount': '0.00', 'requires_shipping': True, 'fulfillment_status': None, 'total_discount_set': {'shop_money': {'amount': '0.00', 'currency_code': 'EUR'}, 'presentment_money': {'amount': '0.00', 'currency_code': 'EUR'}}, 'fulfillment_service': 'manual', 'admin_graphql_api_id': 'gid://shopify/LineItem/14532646732117', 'discount_allocations': [], 'fulfillable_quantity': 1, 'variant_inventory_management': 'shopify'}], 'source_url': None, 'updated_at': '2023-04-17T11:32:14+02:00', 'checkout_id': 41343704662357, 'location_id': None, 'source_name': 'web', 'total_price': '775.00', 'cancelled_at': None, 'fulfillments': [], 'landing_site': '/', 'order_number': 8469, 'processed_at': '2023-04-17T11:32:09+02:00', 'total_weight': 0, 'cancel_reason': None, 'contact_email': 'enora.poignard@gmail.com', 'payment_terms': None, 'total_tax_set': {'shop_money': {'amount': '129.17', 'currency_code': 'EUR'}, 'presentment_money': {'amount': '129.17', 'currency_code': 'EUR'}}, 'checkout_token': '19ae544d29f2e3c66e4ca026bad4ca6e', 'client_details': {'browser_ip': '80.215.36.11', 'user_agent': 'Mozilla/5.0 (Linux; Android 11; FP3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Mobile Safari/537.36', 'session_hash': None, 'browser_width': None, 'browser_height': None, 'accept_language': 'fr-FR'}, 'discount_codes': [], 'referring_site': 'https://www.google.com/', 'shipping_lines': [{'id': 4695326622037, 'code': 'Livraison en point relais (Mondial Relay)', 'phone': None, 'price': '0.00', 'title': 'Livraison en point relais (Mondial Relay)', 'source': 'shopify', 'price_set': {'shop_money': {'amount': '0.00', 'currency_code': 'EUR'}, 'presentment_money': {'amount': '0.00', 'currency_code': 'EUR'}}, 'tax_lines': [{'rate': 0.2, 'price': '0.00', 'title': 'FR TVA', 'price_set': {'shop_money': {'amount': '0.00', 'currency_code': 'EUR'}, 'presentment_money': {'amount': '0.00', 'currency_code': 'EUR'}}, 'channel_liable': False}], 'discounted_price': '0.00', 'delivery_category': None, 'carrier_identifier': '650f1a14fa979ec5c74d063e968411d4', 'discount_allocations': [], 'discounted_price_set': {'shop_money': {'amount': '0.00', 'currency_code': 'EUR'}, 'presentment_money': {'amount': '0.00', 'currency_code': 'EUR'}}, 'requested_fulfillment_service_id': None}], 'subtotal_price': '775.00', 'taxes_included': True, 'billing_address': {'zip': '29200', 'city': 'Brest', 'name': 'Enora Poignard', 'phone': '06 89 58 38 87', 'company': None, 'country': 'France', 'address1': '7b Place des F.T.P.F', 'address2': None, 'latitude': None, 'province': None, 'last_name': 'Poignard', 'longitude': None, 'first_name': 'Enora', 'country_code': 'FR', 'province_code': None}, 'customer_locale': 'fr-FR', 'estimated_taxes': False, 'note_attributes': [{'name': 'lang', 'value': 'fr'}, {'name': 'Invoice Language', 'value': 'fr'}], 'total_discounts': '0.00', 'total_price_set': {'shop_money': {'amount': '775.00', 'currency_code': 'EUR'}, 'presentment_money': {'amount': '775.00', 'currency_code': 'EUR'}}, 'financial_status': 'paid', 'landing_site_ref': None, 'order_status_url': 'https://17h10.com/1452769352/orders/7912169a23e028951f18bcec38c2fc52/authenticate?key=94dbf5f71a3782962df4c5d0055ebc87', 'shipping_address': {'zip': '29200', 'city': 'Brest', 'name': 'Enora Poignard', 'phone': '06 89 58 38 87', 'company': None, 'country': 'France', 'address1': '7b Place des F.T.P.F', 'address2': None, 'latitude': 48.39810620000001, 'province': None, 'last_name': 'Poignard', 'longitude': -4.4853234, 'first_name': 'Enora', 'country_code': 'FR', 'province_code': None}, 'current_total_tax': '129.17', 'processing_method': 'offsite', 'source_identifier': 'fce49de355d7f8ba51b5c7c073d605bd', 'total_outstanding': '0.00', 'fulfillment_status': None, 'subtotal_price_set': {'shop_money': {'amount': '775.00', 'currency_code': 'EUR'}, 'presentment_money': {'amount': '775.00', 'currency_code': 'EUR'}}, 'total_tip_received': '0.00', 'current_total_price': '775.00', 'total_discounts_set': {'shop_money': {'amount': '0.00', 'currency_code': 'EUR'}, 'presentment_money': {'amount': '0.00', 'currency_code': 'EUR'}}, 'admin_graphql_api_id': 'gid://shopify/Order/5549461897557', 'presentment_currency': 'EUR', 'current_total_tax_set': {'shop_money': {'amount': '129.17', 'currency_code': 'EUR'}, 'presentment_money': {'amount': '129.17', 'currency_code': 'EUR'}}, 'discount_applications': [], 'payment_gateway_names': ['PayPlug'], 'current_subtotal_price': '775.00', 'total_line_items_price': '775.00', 'buyer_accepts_marketing': False, 'current_total_discounts': '0.00', 'current_total_price_set': {'shop_money': {'amount': '775.00', 'currency_code': 'EUR'}, 'presentment_money': {'amount': '775.00', 'currency_code': 'EUR'}}, 'current_total_duties_set': None, 'total_shipping_price_set': {'shop_money': {'amount': '0.00', 'currency_code': 'EUR'}, 'presentment_money': {'amount': '0.00', 'currency_code': 'EUR'}}, 'merchant_of_record_app_id': None, 'original_total_duties_set': None, 'current_subtotal_price_set': {'shop_money': {'amount': '775.00', 'currency_code': 'EUR'}, 'presentment_money': {'amount': '775.00', 'currency_code': 'EUR'}}, 'total_line_items_price_set': {'shop_money': {'amount': '775.00', 'currency_code': 'EUR'}, 'presentment_money': {'amount': '775.00', 'currency_code': 'EUR'}}, 'current_total_discounts_set': {'shop_money': {'amount': '0.00', 'currency_code': 'EUR'}, 'presentment_money': {'amount': '0.00', 'currency_code': 'EUR'}}}}

if __name__ == "__main__":
    # test_period_filter()
    # test_fetch_supabase_logs()
    # count_fringuant_orders("./data/orders.csv")
    jsonformated = json.dumps(jsondata, indent=4)
    print(jsonformated)